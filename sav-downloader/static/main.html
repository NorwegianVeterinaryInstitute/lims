<html>
<head>
<title>SAV data preparation tool</title>
<script>
    current_run_checkboxes = []
    archived_run_checkboxes = []

    function getCheckboxAdder(element, collection) {
        return jsonData => {
            for (const s of jsonData.run_ids) {
                var cb = document.createElement("input");
                cb.setAttribute("type", "checkbox");
                cb.setAttribute("value", collection + "/" + s);
                cb.setAttribute("onchange", "writeDownloadLinks()");
                cb.className = "runs-checkbox";
                var label = document.createElement("label");
                label.setAttribute("class", "checkbox-label");
                label.appendChild(cb);
                label.appendChild(document.createTextNode(s));
                element.appendChild(label);
            }
        }
    }

    function showRuns() {
        var element = document.getElementById("current-runs");
        fetch("../runs/current").then(data => data.json()).then(
            getCheckboxAdder(element, "current"));
    }

    function showArchivedRuns() {
        var element = document.getElementById("archived-runs");
        document.getElementById("archived-runs-link").className += "hidden";
        document.getElementById("archived-runs-text").className -= "hidden";
        fetch("../runs/archive").then(data => data.json()).then(
            getCheckboxAdder(element, "archive"));
    }

    function writeDownloadLinks() {
        var wrapper = document.getElementById("download-links");
        var files_qs = document.querySelectorAll(".files-checkbox:checked");
        var files = new Array();
        for (const cb of files_qs) {
            files.push(cb.value);
        }
        var optionsString = "files=" + files.join();
        var containers = document.getElementsByClassName("links-container");
        for (var container of containers) {
            container.remove();
        }
        container = document.createElement("div");
        container.className = "links-container";
        for (const run_cb of document.querySelectorAll(".runs-checkbox:checked")) {
            var run = run_cb.value;
            var link = document.createElement("a");
            var fileName = run.split("/")[1] + ".zip";
            link.setAttribute("href", "../dl/" + run + ".zip?" + optionsString);
            //link.setAttribute("download", fileName);
            link.className = "download-link";
            link.appendChild(document.createTextNode(fileName));
            container.appendChild(link);
        }
        wrapper.appendChild(container);
    }
</script>
<style>
            td {
                vertical-align: top;
            }

            .checkbox-label {
                display: block;
            }

            .hidden {
                display: none;
            }

            a.download-link {
                display: block;
            }

            body {
                padding-bottom: 40px;
            }
</style>
</head>

<body onload="showRuns()">
<div class="header">
    <h1 class="title">SAV data preparation tool</h1>
</div>

<h2>1. Select runs and options</h2>
<table>
    <tr>
        <td>Select Run IDs</td>
        <td>
            <div id="current-runs"></div>
            <div id="archived-runs">
                <a href="#" onclick="showArchivedRuns()" id="archived-runs-link">
                    Show archived runs...</a>
                <div id="archived-runs-text" class="hidden">--- Archived: ---</a>
            </div>
        </td>
    </tr>
    <tr>
        <td>Items to include:</td>
        <td>
                <div>
                    <label class="checkbox-label">
                        <input type="checkbox" value="runParameters.xml" checked
                                class="files-checkbox" onchange="writeDownloadLinks()">
                        runParameters.xml
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="RunInfo.xml" checked
                                class="files-checkbox" onchange="writeDownloadLinks()">
                        RunInfo.xml
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="InterOp" checked
                                class="files-checkbox" onchange="writeDownloadLinks()">
                        InterOp
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="SampleSheet.csv"
                                class="files-checkbox" onchange="writeDownloadLinks()">
                        SampleSheet.csv
                    </label>
                </div>
        </td>
    </tr>
</table>

<h2>2. Download data</h2>
<p>Please right-click the link(s) below and select Save As... to download them onto your portable storage device.</p>

<div id="download-links">
</div>

</body>
</html>
